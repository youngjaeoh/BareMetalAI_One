# Thread SPI Communication Protocol Documentation

## 1. Overview

이 문서는 STM32H743과 ESP32C6 간의 SPI 통신 프로토콜을 정의합니다.

### 1.1 통신 구조
- **마스터**: STM32H743 (SPI4)
- **슬레이브**: ESP32C6
- **통신 방식**: Full-duplex SPI
- **데이터 크기**: 8-bit
- **클럭 속도**: 시스템 클럭 / 8 (약 12MHz)

### 1.2 핀 할당
```
STM32H743    ESP32C6
PE12 (SCK) → SCK
PE14 (MOSI) → MOSI
PE13 (MISO) ← MISO
PE11 (CS) → CS (소프트웨어 제어)
```

## 2. Packet Structure

### 2.1 기본 패킷 구조
```c
typedef struct {
    uint8_t header;      // 0x80 (고정값)
    uint8_t command;     // 명령어 (0x01 ~ 0x05)
    uint8_t length;      // 데이터 길이 (0-32바이트)
    uint8_t data[32];    // 데이터 (최대 32바이트)
} Thread_SPI_Packet_t;
```

### 2.2 패킷 필드 설명

| 필드 | 크기 | 값 | 설명 |
|------|------|----|----|
| header | 1바이트 | 0x80 | 패킷 시작 식별자 |
| command | 1바이트 | 0x01~0x05 | 명령어 코드 |
| length | 1바이트 | 0-32 | 데이터 길이 |
| data | 0-32바이트 | - | 실제 데이터 |

## 3. Command Definitions

### 3.1 명령어 목록

| 명령어 | 값 | 방향 | 설명 |
|--------|----|----|----|
| THREAD_SPI_CMD_SEND | 0x01 | Master→Slave | 데이터 전송 |
| THREAD_SPI_CMD_RECEIVE | 0x02 | Master→Slave | 데이터 수신 요청 |
| THREAD_SPI_CMD_PING | 0x03 | Master→Slave | 연결 확인 |
| THREAD_SPI_CMD_PONG | 0x04 | Slave→Master | Ping 응답 |
| THREAD_SPI_CMD_STATUS | 0x05 | Master→Slave | 상태 정보 요청 |

### 3.2 명령어 상세 설명

#### 3.2.1 SEND (0x01)
- **목적**: 마스터에서 슬레이브로 데이터 전송
- **데이터**: 문자열 또는 바이너리 데이터
- **예시**: `[0x80][0x01][0x0B]["Hello World"]`

#### 3.2.2 RECEIVE (0x02)
- **목적**: 슬레이브에서 데이터 수신 요청
- **데이터**: 없음 (length = 0)
- **응답**: 슬레이브가 데이터를 전송

#### 3.2.3 PING (0x03)
- **목적**: 연결 상태 확인
- **데이터**: 없음 (length = 0)
- **응답**: PONG (0x04)

#### 3.2.4 PONG (0x04)
- **목적**: Ping에 대한 응답
- **데이터**: 없음 (length = 0)
- **발신**: 슬레이브

#### 3.2.5 STATUS (0x05)
- **목적**: 시스템 상태 정보 요청
- **데이터**: 없음 (length = 0)
- **응답**: Thread_Status_Info_t 구조체

## 4. Data Structures

### 4.1 시스템 상태 정보
```c
typedef struct {
    uint32_t uptime;     // 시스템 업타임 (밀리초)
    uint8_t status;      // 상태 플래그 (0x01: 정상)
    uint16_t free_memory; // 사용 가능한 메모리 (KB)
    float cpu_temp;      // CPU 온도 (섭씨)
} Thread_Status_Info_t;
```

### 4.2 상태 플래그 정의
| 비트 | 설명 |
|------|----|
| 0 | 시스템 정상 (1: 정상, 0: 오류) |
| 1 | SPI 통신 상태 (1: 정상, 0: 오류) |
| 2 | 메모리 상태 (1: 정상, 0: 부족) |
| 3-7 | 예약됨 |

## 5. Communication Flow

### 5.1 기본 통신 순서
```
1. 마스터가 패킷 전송
2. 슬레이브가 패킷 수신 및 처리
3. 슬레이브가 응답 패킷 전송 (필요시)
4. 마스터가 응답 수신
```

### 5.2 Ping-Pong 예시
```
Master → [0x80][0x03][0x00] (PING)
Slave  → [0x80][0x04][0x00] (PONG)
```

### 5.3 데이터 전송 예시
```
Master → [0x80][0x01][0x0B]["Hello World"]
Slave  → [0x80][0x01][0x0D]["Hello Master"]
```

## 6. Error Handling

### 6.1 에러 코드
| 코드 | 설명 |
|------|----|
| HAL_OK | 성공 |
| HAL_ERROR | 일반 오류 |
| HAL_TIMEOUT | 타임아웃 (1초) |
| HAL_BUSY | 통신 중 |

### 6.2 에러 처리 방법
1. **타임아웃**: 1초 내 응답 없으면 재시도
2. **헤더 오류**: 0x80이 아니면 패킷 무시
3. **길이 오류**: 32바이트 초과시 패킷 무시
4. **명령어 오류**: 알 수 없는 명령어시 에러 응답

## 7. Timing Requirements

### 7.1 타이밍 제약
- **패킷 간격**: 최소 1ms
- **응답 타임아웃**: 1초
- **재시도 횟수**: 최대 3회
- **통신 속도**: 12MHz (시스템 클럭 / 8)

### 7.2 타이밍 다이어그램
```
Master:  ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐
SCK      │ │ │ │ │ │ │ │ │ │ │ │
         └─┘ └─┘ └─┘ └─┘ └─┘ └─┘
         
Master:  ┌─────────────────┐
MOSI     │   Packet Data   │
         └─────────────────┘
         
Slave:   ┌─────────────────┐
MISO     │  Response Data  │
         └─────────────────┘
```

## 8. Implementation Guidelines

### 8.1 ESP32C6 구현 시 주의사항
1. **SPI 설정**: 마스터 모드, 8비트 데이터, MSB first
2. **CS 제어**: 소프트웨어로 제어
3. **버퍼 관리**: 32바이트 수신 버퍼 준비
4. **에러 처리**: 타임아웃 및 재시도 로직 구현

### 8.2 권장 구현 순서
1. 기본 SPI 통신 설정
2. 패킷 수신/전송 함수 구현
3. 명령어 처리 함수 구현
4. 에러 처리 및 재시도 로직 추가
5. 상태 모니터링 기능 추가

## 9. Testing

### 9.1 테스트 시나리오
1. **연결 테스트**: Ping-Pong
2. **데이터 전송 테스트**: 문자열 송수신
3. **상태 정보 테스트**: 시스템 상태 요청
4. **에러 테스트**: 잘못된 패킷 처리
5. **성능 테스트**: 대용량 데이터 전송

### 9.2 테스트 데이터
- **문자열**: "Hello World", "ESP32C6 Test"
- **숫자**: 12345, -67890
- **바이너리**: 0x00~0xFF 패턴

## 10. Troubleshooting

### 10.1 일반적인 문제
1. **통신 안됨**: SPI 설정 확인, 핀 연결 확인
2. **데이터 오류**: 클럭 속도, 데이터 순서 확인
3. **타임아웃**: 응답 처리 속도 개선
4. **패킷 손실**: 버퍼 크기, 처리 속도 확인

### 10.2 디버깅 방법
1. UART로 패킷 내용 출력
2. 오실로스코프로 SPI 신호 확인
3. 로직 애널라이저로 타이밍 분석
4. 단계별 테스트로 문제 지점 파악

---

**문서 버전**: 1.0  
**작성일**: 2024년  
**작성자**: STM32H743 개발팀 